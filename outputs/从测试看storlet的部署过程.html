
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="zh_CN">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>从测试看storlet的部署过程 &#8212; Starry 0.0.1 文档</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/translations.js"></script>
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜索" href="../search.html" />
    <link rel="next" title="使用elixir来开发一个分布式存储系统" href="使用elixir来开发一个分布式存储系统.html" />
    <link rel="prev" title="windows下seaweedfs开发环境搭建" href="windows下seaweedfs开发环境搭建.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="storlet">
<h1>从测试看storlet的部署过程<a class="headerlink" href="#storlet" title="永久链接至标题">¶</a></h1>
<p>storlet的测试入口<code class="docutils literal"><span class="pre">.unittest</span></code>如下：</p>
<div class="code shell highlight-default"><div class="highlight"><pre><span></span>#! /bin/bash

SRC_DIR=$(python -c &quot;import os; print(os.path.dirname(os.path.realpath(&#39;$0&#39;)))&quot;)    #获取当前目录绝对地址
cd ${SRC_DIR}/tests/unit    #进入测试目录
nosetests --exe -v $@   #执行测试，返回结果
rvalue=$?   #返回上次的返回值
cd -    #返回上一次工作目录

exit $rvalue
</pre></div>
</div>
<p>nosetest是一个python测试模块，它能够检测当前目录下所有的测试文件、方法并执行测试。然后我们的目的是为了理解storlet的运行流程，那么可以先找到一个一个用于测试某个storlet功能的用例，比如<code class="docutils literal"><span class="pre">tests/functional/java/test_compress_storlet.py</span></code>的部分代码如下:</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span>from swiftclient import client as c
from tests.functional.java import StorletJavaFunctionalTest
import unittest


class TestCompressStorlet(StorletJavaFunctionalTest):
    def setUp(self):
        self.storlet_log = &#39;&#39;
        self.additional_headers = {}
        main_class = &#39;org.openstack.storlet.compress.CompressStorlet&#39;
        super(TestCompressStorlet, self).setUp(&#39;CompressStorlet&#39;,
                                               &#39;compressstorlet-1.0.jar&#39;,
                                               main_class,
                                               &#39;input.txt&#39;)

    def test_put(self):
        headers = {&#39;X-Run-Storlet&#39;: self.storlet_name}
        headers.update(self.additional_headers)
        querystring = &quot;action=compress&quot;

        # simply set 1KB string data to compress
        data = &#39;A&#39; * 1024

··· ···
</pre></div>
</div>
<p>先去看一下它的父类<code class="docutils literal"><span class="pre">StorletJavaFunctionalTest</span></code>,它的代码如下：</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">tests.functional</span> <span class="k">import</span> <span class="n">StorletFunctionalTest</span><span class="p">,</span> <span class="n">PATH_TO_STORLETS</span>

<span class="n">BIN_DIR</span> <span class="o">=</span> <span class="s1">&#39;bin&#39;</span>


<span class="k">class</span> <span class="nc">StorletJavaFunctionalTest</span><span class="p">(</span><span class="n">StorletFunctionalTest</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">storlet_dir</span><span class="p">,</span> <span class="n">storlet_name</span><span class="p">,</span> <span class="n">storlet_main</span><span class="p">,</span>
              <span class="n">storlet_file</span><span class="p">,</span> <span class="n">dep_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">storlet_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;java&#39;</span><span class="p">,</span> <span class="n">storlet_dir</span><span class="p">)</span>
        <span class="n">path_to_bundle</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH_TO_STORLETS</span><span class="p">,</span> <span class="n">storlet_dir</span><span class="p">,</span>
                                      <span class="n">BIN_DIR</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">StorletJavaFunctionalTest</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUp</span><span class="p">(</span><span class="s1">&#39;Java&#39;</span><span class="p">,</span>
                                                     <span class="n">path_to_bundle</span><span class="p">,</span>
                                                     <span class="n">storlet_dir</span><span class="p">,</span>
                                                     <span class="n">storlet_name</span><span class="p">,</span>
                                                     <span class="n">storlet_main</span><span class="p">,</span>
                                                     <span class="n">storlet_file</span><span class="p">,</span>
                                                     <span class="n">dep_names</span><span class="p">,</span>
                                                     <span class="n">headers</span><span class="p">)</span>
</pre></div>
</div>
<p>可以看到它的逻辑很简单，只是在语言选项那里换成了java，想必另外一个用python写的storlet也是类似。再看它的父类<code class="docutils literal"><span class="pre">StorletFunctionalTest</span></code>:</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">import</span> <span class="nn">uuid</span>

<span class="kn">from</span> <span class="nn">swiftclient</span> <span class="k">import</span> <span class="n">client</span> <span class="k">as</span> <span class="n">swiftclient</span>
<span class="kn">from</span> <span class="nn">storlets.tools.cluster_config_parser</span> <span class="k">import</span> <span class="n">ClusterConfig</span>
<span class="kn">from</span> <span class="nn">storlets.tools.utils</span> <span class="k">import</span> <span class="n">deploy_storlet</span><span class="p">,</span> <span class="n">get_admin_auth</span><span class="p">,</span> <span class="n">put_local_file</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">CONFIG_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CLUSTER_CONF_DIR&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>
<span class="n">CONFIG_FILE</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CONFIG_DIR</span><span class="p">,</span> <span class="s1">&#39;cluster_config.json&#39;</span><span class="p">)</span>
<span class="n">PATH_TO_STORLETS</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
    <span class="s1">&#39;STORLET_SAMPLE_PATH&#39;</span><span class="p">,</span>
    <span class="c1"># assuming, current working dir is at top of storlet repo</span>
    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s1">&#39;StorletSamples&#39;</span><span class="p">))</span>
<span class="n">CONSOLE_TIMEOUT</span> <span class="o">=</span> <span class="mi">2</span>


<span class="k">class</span> <span class="nc">StorletBaseFunctionalTest</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conf_file</span> <span class="o">=</span> <span class="n">CONFIG_FILE</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conf</span> <span class="o">=</span> <span class="n">ClusterConfig</span><span class="p">(</span><span class="n">CONFIG_FILE</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s1">&#39;cluster_config.json not found in </span><span class="si">%s</span><span class="s1">. &#39;</span>
                      <span class="s1">&#39;Please check your testing environment.&#39;</span> <span class="o">%</span> <span class="n">CONFIG_DIR</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="n">get_admin_auth</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="p">)</span>
        <span class="c1"># TODO(kota_): do we need to call setUp() when inheriting TestCase</span>
        <span class="c1"># directly? AFAIK, no setUp method in the class...</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">StorletBaseFunctionalTest</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">StorletFunctionalTest</span><span class="p">(</span><span class="n">StorletBaseFunctionalTest</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">create_container</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">container</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">swiftclient</span><span class="o">.</span><span class="n">put_container</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">,</span>
                                  <span class="n">container</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                  <span class="n">response_dict</span><span class="o">=</span><span class="n">response</span><span class="p">)</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;=</span> <span class="mi">200</span> <span class="ow">or</span> <span class="n">status</span> <span class="o">&lt;</span> <span class="mi">300</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">cleanup_container</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">container</span><span class="p">):</span>
        <span class="c1"># list all objects inside the container</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">objects</span> <span class="o">=</span> <span class="n">swiftclient</span><span class="o">.</span><span class="n">get_container</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">,</span> <span class="n">container</span><span class="p">,</span> <span class="n">full_listing</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># delete all objects inside the container</span>
        <span class="c1"># N.B. this cleanup could run in parallel but currently we have a few</span>
        <span class="c1"># objects in the user testing container so that, currently this does</span>
        <span class="c1"># as sequential simply</span>
        <span class="k">for</span> <span class="n">obj_dict</span> <span class="ow">in</span> <span class="n">objects</span><span class="p">:</span>
            <span class="n">swiftclient</span><span class="o">.</span><span class="n">delete_object</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">,</span> <span class="n">container</span><span class="p">,</span> <span class="n">obj_dict</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
        <span class="n">swiftclient</span><span class="o">.</span><span class="n">get_container</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">,</span> <span class="n">container</span><span class="p">)</span>

        <span class="c1"># delete the container</span>
        <span class="n">swiftclient</span><span class="o">.</span><span class="n">delete_container</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">,</span> <span class="n">container</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">language</span><span class="p">,</span> <span class="n">path_to_bundle</span><span class="p">,</span>
              <span class="n">storlet_dir</span><span class="p">,</span>
              <span class="n">storlet_name</span><span class="p">,</span> <span class="n">storlet_main</span><span class="p">,</span> <span class="n">storlet_file</span><span class="p">,</span>
              <span class="n">dep_names</span><span class="p">,</span> <span class="n">headers</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">StorletFunctionalTest</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storlet_dir</span> <span class="o">=</span> <span class="n">storlet_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storlet_name</span> <span class="o">=</span> <span class="n">storlet_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storlet_main</span> <span class="o">=</span> <span class="n">storlet_main</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dep_names</span> <span class="o">=</span> <span class="n">dep_names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path_to_bundle</span> <span class="o">=</span> <span class="n">path_to_bundle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">container</span> <span class="o">=</span> <span class="s1">&#39;container-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storlet_file</span> <span class="o">=</span> <span class="n">storlet_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">4</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">dep_names</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dep_names</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">deps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_to_bundle</span><span class="p">,</span> <span class="n">d</span><span class="p">))</span>
        <span class="n">storlet</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_to_bundle</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">storlet_name</span><span class="p">)</span>

        <span class="n">deploy_storlet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">,</span>
                       <span class="n">storlet</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">storlet_main</span><span class="p">,</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">deps</span><span class="p">,</span> <span class="n">language</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">create_container</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">storlet_file</span><span class="p">:</span>
            <span class="n">put_local_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">path_to_bundle</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">storlet_file</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cleanup_container</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="p">)</span>
</pre></div>
</div>
<p>可以看到这个类是我们想找的类，它封装了storlet的部署流程。下面就来分析一下这个类。</p>
<p>他首先定义了一些依赖，比如docker和编译好的storlet(在这里是jar,python那边有所不同)。先看一下docker的配置文件<code class="docutils literal"><span class="pre">cluster_config.json</span></code>。我的配置文件如下：</p>
<div class="code json highlight-default"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;groups&quot;</span> <span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;storlet-mgmt&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">],</span>
        <span class="s2">&quot;storlet-proxy&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">],</span>
        <span class="s2">&quot;storlet-storage&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">],</span>
        <span class="s2">&quot;docker&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">]</span>
    <span class="p">},</span>
    <span class="s2">&quot;all&quot;</span> <span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;ansible_ssh_user&quot;</span> <span class="p">:</span> <span class="s2">&quot;daqu&quot;</span><span class="p">,</span>
        <span class="s2">&quot;docker_device&quot;</span><span class="p">:</span> <span class="s2">&quot;/home/docker_device&quot;</span><span class="p">,</span>
        <span class="s2">&quot;storlet_source_dir&quot;</span><span class="p">:</span> <span class="s2">&quot;~/storlets/&quot;</span><span class="p">,</span>
        <span class="s2">&quot;python_dist_packages_dir&quot;</span><span class="p">:</span> <span class="s2">&quot;usr/local/lib/python2.7/dist-packages&quot;</span><span class="p">,</span>
        <span class="s2">&quot;storlet_gateway_conf_file&quot;</span><span class="p">:</span> <span class="s2">&quot;/etc/swift/storlet_docker_gateway.conf&quot;</span><span class="p">,</span>
        <span class="s2">&quot;keystone_endpoint_host&quot;</span><span class="p">:</span> <span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;keystone_public_url&quot;</span><span class="p">:</span> <span class="s2">&quot;http://127.0.0.1/identity/v3&quot;</span><span class="p">,</span>
        <span class="s2">&quot;keystone_admin_url&quot;</span><span class="p">:</span> <span class="s2">&quot;http://127.0.0.1/identity_admin&quot;</span><span class="p">,</span>
        <span class="s2">&quot;keystone_admin_password&quot;</span><span class="p">:</span> <span class="s2">&quot;admin&quot;</span><span class="p">,</span>
        <span class="s2">&quot;keystone_admin_user&quot;</span><span class="p">:</span> <span class="s2">&quot;admin&quot;</span><span class="p">,</span>
        <span class="s2">&quot;keystone_admin_project&quot;</span><span class="p">:</span> <span class="s2">&quot;admin&quot;</span><span class="p">,</span>
        <span class="s2">&quot;keystone_default_domain&quot;</span><span class="p">:</span> <span class="s2">&quot;default&quot;</span><span class="p">,</span>
        <span class="s2">&quot;keystone_auth_version&quot;</span><span class="p">:</span> <span class="s2">&quot;3&quot;</span><span class="p">,</span>
        <span class="s2">&quot;swift_endpoint_host&quot;</span><span class="p">:</span> <span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;swift_run_time_user&quot;</span> <span class="p">:</span> <span class="s2">&quot;daqu&quot;</span><span class="p">,</span>
        <span class="s2">&quot;swift_run_time_group&quot;</span> <span class="p">:</span> <span class="s2">&quot;daqu&quot;</span><span class="p">,</span>
        <span class="s2">&quot;swift_run_time_dir&quot;</span><span class="p">:</span> <span class="s2">&quot;/opt/stack/data/swift/run&quot;</span><span class="p">,</span>
        <span class="s2">&quot;storlets_management_user&quot;</span><span class="p">:</span> <span class="s2">&quot;daqu&quot;</span><span class="p">,</span>
        <span class="s2">&quot;storlet_management_account&quot;</span><span class="p">:</span> <span class="s2">&quot;storlet_management&quot;</span><span class="p">,</span>
        <span class="s2">&quot;storlet_management_admin_username&quot;</span><span class="p">:</span> <span class="s2">&quot;storlet_manager&quot;</span><span class="p">,</span>
        <span class="s2">&quot;storlet_manager_admin_password&quot;</span><span class="p">:</span> <span class="s2">&quot;storlet_manager&quot;</span><span class="p">,</span>
        <span class="s2">&quot;storlet_management_swift_topology_container&quot;</span><span class="p">:</span> <span class="s2">&quot;swift_cluster&quot;</span><span class="p">,</span>
        <span class="s2">&quot;storlet_management_swift_topology_object&quot;</span><span class="p">:</span> <span class="s2">&quot;cluster_config.json&quot;</span><span class="p">,</span>
        <span class="s2">&quot;storlet_management_ansible_dir&quot;</span><span class="p">:</span> <span class="s2">&quot;/opt/ibm/ansible/playbook&quot;</span><span class="p">,</span>
        <span class="s2">&quot;storlet_management_install_dir&quot;</span><span class="p">:</span> <span class="s2">&quot;/opt/ibm&quot;</span><span class="p">,</span>
        <span class="s2">&quot;storlets_enabled_attribute_name&quot;</span><span class="p">:</span> <span class="s2">&quot;storlet-enabled&quot;</span><span class="p">,</span>
        <span class="s2">&quot;docker_registry_random_string&quot;</span><span class="p">:</span> <span class="s2">&quot;ABCDEFGHIJABCDEFGHIJABCDEFGHIJABCDEFGHIJABCDEFGHIJABCDEFGHIJ1234&quot;</span><span class="p">,</span>
        <span class="s2">&quot;docker_registry_port&quot;</span><span class="p">:</span> <span class="s2">&quot;5001&quot;</span><span class="p">,</span>
        <span class="s2">&quot;container_install_dir&quot;</span><span class="p">:</span> <span class="s2">&quot;/opt/storlets&quot;</span><span class="p">,</span>
        <span class="s2">&quot;storlets_default_project_name&quot;</span><span class="p">:</span> <span class="s2">&quot;test&quot;</span><span class="p">,</span>
        <span class="s2">&quot;storlets_default_project_user_name&quot;</span><span class="p">:</span> <span class="s2">&quot;tester&quot;</span><span class="p">,</span>
        <span class="s2">&quot;storlets_default_project_user_password&quot;</span><span class="p">:</span> <span class="s2">&quot;testing&quot;</span><span class="p">,</span>
        <span class="s2">&quot;storlets_default_project_member_user&quot;</span> <span class="p">:</span> <span class="s2">&quot;tester_member&quot;</span><span class="p">,</span>
        <span class="s2">&quot;storlets_default_project_member_password&quot;</span> <span class="p">:</span> <span class="s2">&quot;member&quot;</span><span class="p">,</span>
        <span class="s2">&quot;base_image_maintainer&quot;</span><span class="p">:</span> <span class="s2">&quot;root&quot;</span><span class="p">,</span>
        <span class="s2">&quot;base_os_image&quot;</span><span class="p">:</span> <span class="s2">&quot;ubuntu_16.04&quot;</span><span class="p">,</span>
        <span class="s2">&quot;storlets_image_name_suffix&quot;</span><span class="p">:</span> <span class="s2">&quot;ubuntu_16.04_jre8_storlets&quot;</span><span class="p">,</span>
        <span class="s2">&quot;swift_user_id&quot;</span><span class="p">:</span> <span class="s2">&quot;1003&quot;</span><span class="p">,</span>
        <span class="s2">&quot;swift_group_id&quot;</span><span class="p">:</span> <span class="s2">&quot;1003&quot;</span><span class="p">,</span>
        <span class="s2">&quot;storlet_middleware&quot;</span><span class="p">:</span> <span class="s2">&quot;storlet_handler&quot;</span><span class="p">,</span>
        <span class="s2">&quot;storlet_container&quot;</span><span class="p">:</span> <span class="s2">&quot;storlet&quot;</span><span class="p">,</span>
        <span class="s2">&quot;storlet_dependency&quot;</span><span class="p">:</span> <span class="s2">&quot;dependency&quot;</span><span class="p">,</span>
        <span class="s2">&quot;storlet_log&quot;</span><span class="p">:</span> <span class="s2">&quot;storletlog&quot;</span><span class="p">,</span>
        <span class="s2">&quot;storlet_images&quot;</span><span class="p">:</span> <span class="s2">&quot;docker_images&quot;</span><span class="p">,</span>
        <span class="s2">&quot;storlet_timeout&quot;</span><span class="p">:</span> <span class="s2">&quot;40&quot;</span><span class="p">,</span>
        <span class="s2">&quot;storlet_gateway_module&quot;</span><span class="p">:</span> <span class="s2">&quot;docker&quot;</span><span class="p">,</span>
        <span class="s2">&quot;storlet_execute_on_proxy_only&quot;</span><span class="p">:</span> <span class="s2">&quot;false&quot;</span><span class="p">,</span>
        <span class="s2">&quot;restart_linux_container_timeout&quot;</span><span class="p">:</span> <span class="s2">&quot;3&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>从上面可以看出，这个配置文件主要是设置docker中的storlet。</p>
<p>然后便是编译好的storlet
jar包。这个需要手动复制到<code class="docutils literal"><span class="pre">functional</span></code>目录下，否则测试会报错。</p>
<p>接下来便是<code class="docutils literal"><span class="pre">StorletBaseFunctionalTest</span></code>，它先在读取docker配置文件，再通过get_admin_auth方法获取swift认证，事实上这个方法只是对swiftclient.get_auth方法进行了进一步的封装。然后这个类就结束了。它的功能很简单，读取配置和向swift发起认证请求。在这里值得一提的是get_admin_auth方法被定义在<code class="docutils literal"><span class="pre">storlets/tools/utils.py</span></code>中，这个模块还定义了如何上传一个storlet的过程。作者先是定义了一个将本地文件上传到swift的方法<code class="docutils literal"><span class="pre">put_local_file</span></code>，然后在定义一个方法<code class="docutils literal"><span class="pre">put_storlet_object</span></code>来调用前者上传storlet。在第二个方法中，作者指定了storlet上传的容器是storlet，并且在请求元数据中加入了和storlet相关的部分，比如：</p>
<div class="code html highlight-default"><div class="highlight"><pre><span></span><span class="s1">&#39;X-Object-Meta-Storlet-Language&#39;</span><span class="p">:</span> <span class="n">language</span><span class="p">,</span>
<span class="s1">&#39;X-Object-Meta-Storlet-Interface-Version&#39;</span><span class="p">:</span> <span class="s1">&#39;1.0&#39;</span><span class="p">,</span>
<span class="s1">&#39;X-Object-Meta-Storlet-Object-Metadata&#39;</span><span class="p">:</span> <span class="s1">&#39;no&#39;</span><span class="p">,</span>
<span class="s1">&#39;X-Object-Meta-Storlet-Main&#39;</span><span class="p">:</span> <span class="n">storlet_main_class</span>
</pre></div>
</div>
<p>此外，还有一个方法<code class="docutils literal"><span class="pre">put_storlet_executable_dependencies</span></code>，它的作用和<code class="docutils literal"><span class="pre">put_storlet_object</span></code>类似，但是它上传的是依赖，上传的容器是dependency。</p>
<p>当一个storlet和它的依赖都被上传时，这个storlet就算部署成功了。</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">deploy_storlet</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">storlet</span><span class="p">,</span> <span class="n">storlet_main_class</span><span class="p">,</span> <span class="n">dependencies</span><span class="p">,</span>
                   <span class="n">language</span><span class="o">=</span><span class="s1">&#39;Java&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Deploy storlet file and required dependencies as swift objects</span>

<span class="sd">    :param url: swift endpoint url</span>
<span class="sd">    :param token: token string to access swift</span>
<span class="sd">    :param storlet: storlet file to be registerd</span>
<span class="sd">    :param dependencies: a list of dependency files to be registered</span>
<span class="sd">    :param language: storlet language. default value is Java</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># No need to create containers every time</span>
    <span class="c1"># put_storlet_containers(url, token)</span>
    <span class="n">put_storlet_object</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">storlet</span><span class="p">,</span>
                       <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dependencies</span><span class="p">),</span>
                       <span class="n">storlet_main_class</span><span class="p">,</span> <span class="n">language</span><span class="p">)</span>

    <span class="n">put_storlet_executable_dependencies</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">dependencies</span><span class="p">)</span>
</pre></div>
</div>
<p>然后是<code class="docutils literal"><span class="pre">StorletFunctionalTest(StorletBaseFunctionalTest)</span></code>，这个类其实是对刚才介绍的util模块的一次应用。在这个模块对这些方法又进行了封装。</p>
<p>至此，整个storlet的溯源流程就结束了。总结一下：</p>
<ul class="simple">
<li>strolet的类结构从上到下为：</li>
<li>unittest.TestCase</li>
<li>StorletFunctionalTest</li>
<li>StorletJavaFunctionalTest(StorletPythonFunctionalTest)</li>
<li>TestCompressStorlet(实际的storlet)</li>
<li>每一层的类都是对storlet/util.py中操作的进一步封装</li>
<li>storlet/util中定义部署storlet的方法</li>
</ul>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">Starry</a></h1>








<h3>导航</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../days/index.html">日报</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">输出</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">输出</a><ul>
      <li>Previous: <a href="windows下seaweedfs开发环境搭建.html" title="上一章">windows下seaweedfs开发环境搭建</a></li>
      <li>Next: <a href="使用elixir来开发一个分布式存储系统.html" title="下一章">使用elixir来开发一个分布式存储系统</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>快速搜索</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="转向" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, daqu.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.6.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
      |
      <a href="../_sources/outputs/从测试看storlet的部署过程.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>