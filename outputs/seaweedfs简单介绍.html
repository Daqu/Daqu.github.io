
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="zh_CN">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>seaweedfs简单介绍 &#8212; Starry 0.0.1 文档</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/translations.js"></script>
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜索" href="../search.html" />
    <link rel="next" title="openstack swift middleware" href="swift_middleware.html" />
    <link rel="prev" title="seaweedfs源码阅读(二)" href="seaweedfs源码阅读(二).html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="seaweedfs">
<h1>seaweedfs简单介绍<a class="headerlink" href="#seaweedfs" title="永久链接至标题">¶</a></h1>
<p>seaweedfs是haystack的一个开源实现。名字是海草，这也反映了它和haystack(草垛的关系)</p>
<div class="section" id="id1">
<h2>架构<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h2>
<blockquote>
<div><p>分布式文件系统的拓扑结构大体都类似，分为NameNode和DataNode，NameNode负责管理数据节点拓扑结构以及元数据，DataNode负责真实数据存储；在seaweedfs文件系统中，NameNode称为Master，DataNode称为VolumeServer。</p>
<div class="figure" id="id4">
<img alt="架构" src="http://7xjnip.com1.z0.glb.clouddn.com/ldw-IMG_07861.JPG" />
<p class="caption"><span class="caption-text">架构</span></p>
</div>
<p>由架构图可以看出，</p>
<ul class="simple">
<li>Master负责管理集群的拓扑结构，分为主从结构，并采用raft实现主从复制和高可用，以此消除单点问题；TFS中的NameNode为了消除单点问题，采取的是虚拟IP配上lvs；</li>
<li>DataNode负责存储具体数据，并与M-Master保持心跳，上报自己的存储信息；</li>
</ul>
<p>当客户端需要存储数据时，</p>
<ol class="arabic">
<li><p class="first">需要先给M-Master发送请求，获取该文件存储的DataNode地址，文件存储的VolumeID以及文件fid;</p>
</li>
<li><p class="first">然后客户端接着将文件发送至从Master获取到的DataNode，DataNode会根据VolumeID找到相应的Volume，并将文件存储到该Volume;</p>
<blockquote>
<div><p>分布式文件系统数据节点存储数据时，会创建出若干个大文件(可以想象为磁盘)，用于存储小文件，例如文件，短视频等等；在seaweedfs中，大文件就称为Volume；</p>
</div></blockquote>
</li>
</ol>
<p>ok，上述是正常情况下seaweedfs运行时的整体架构图，但是机器的东西，说不准哪天就挂了，特别是Master，因为Master挂了，整个文件系统就不可用了；在seaweedfs是通过raft实现高可用，即使M-Master挂了，会通过选举算法，在S-Master选举出新的M-Master，然后所有DataNode则将自己的信息上报给新的M-Master；结构图如下:</p>
<div class="figure" id="id5">
<img alt="容错" src="http://7xjnip.com1.z0.glb.clouddn.com/ldw-IMG_07871.JPG" />
<p class="caption"><span class="caption-text">容错</span></p>
</div>
<p>图中可以看出，当M-Master挂了之后，剩余两个S-Master会进行选举，产生新的M-Master，此时所有的DataNode将会连接到新的M-Master，并上报自己的存储信息；而客户端下次需要存储文件时，会先到选举产生的新M-Master获取DataNode信息，然后再将文件存储到具体DataNode；</p>
<p>这里，client是如何连接到新的M-Master的，我不是很清楚，因此没有在实际生产环境中部署使用过，但是我觉得可以通过客户端轮询来实现。</p>
<p>接下来，我们来看下Master拓扑结构，如下图:</p>
<div class="figure" id="id6">
<img alt="topology\_arch" src="http://7xjnip.com1.z0.glb.clouddn.com/ldw-IMG_07881.JPG" />
<p class="caption"><span class="caption-text">topology_arch</span></p>
</div>
<p>seaweedfs拓扑结构主要有三个概念，数据中心(DataCenter)，机架(Rack)，数据节点(DataNode)；这样可以很灵活配置不同数据中心，同一个数据中心下不同机架，同一机架下不同的数据节点；数据都是存储在DataNode中；</p>
<p>最后再来看下DataNode存储节点Volumn布局；如下:</p>
<div class="code shell highlight-default"><div class="highlight"><pre><span></span><span class="o">+-------------+</span>
<span class="o">|</span> <span class="n">SuperBlock</span>  <span class="o">|</span>
<span class="o">+-------------+</span>
<span class="o">|</span> <span class="n">Needle1</span>     <span class="o">|</span>
<span class="o">+-------------+</span>
<span class="o">|</span> <span class="n">Needle2</span>     <span class="o">|</span>
<span class="o">+-------------+</span>
<span class="o">|</span> <span class="n">Needle3</span>     <span class="o">|</span>
<span class="o">+-------------+</span>
<span class="o">|</span> <span class="n">Needle</span><span class="o">...</span>   <span class="o">|</span>
<span class="o">+-------------+</span>
</pre></div>
</div>
<p>一般情况下，一个DataNode会配置多个Volume，这样可以避免多个客户端对同一个Volume读写争抢；每个Volume由一个SuperBlock和若干个Needle组成；每个Needle则代表一个小文件，例如图片和短视频</p>
</div></blockquote>
</div>
<div class="section" id="id2">
<h2>安装与使用<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h2>
<p>seaweedfs的安装很简单，它本身编译后就只有一个可执行文件，也不依赖额外的库。但是我是在windows在进行安装，因此还需要额外安装<a class="reference external" href="https://curl.haxx.se/">curl</a>。curl本身也是编译好的程序，将它的<code class="docutils literal"><span class="pre">bin</span></code>目录加进环境变量。为了省事，我把<code class="docutils literal"><span class="pre">weedfs.exe</span></code>扔进了curl的<code class="docutils literal"><span class="pre">bin</span></code>目录，这样安装过程就完成了。</p>
<p>seaweedfs的启动很简单，他需要至少一个master服务和一个storage服务。在这里，master和storage服务都在一台机子上。组合是一个master和两个storage。启动过程如下：</p>
<p>MASTER</p>
<div class="code powershell highlight-default"><div class="highlight"><pre><span></span># in windows 10 x64
C:\Users\aloor&gt;cd Desktop
C:\Users\aloor\Desktop&gt;cd temp
C:\Users\aloor\Desktop\temp&gt;weed master

I0808 15:46:57 13248 file_util.go:20] Folder C:\Users\aloor\AppData\Local\Temp Permission: -rwxrwxrwx
I0808 15:46:57 13248 master_server.go:62] Volume Size Limit is 30000 MB
I0808 15:46:57 13248 master.go:87] Start Seaweed Master 0.76 at 0.0.0.0:9333
I0808 15:46:57 13248 raft_server.go:56] Peers Change: [localhost:9333] =&gt; []
I0808 15:46:57 13248 raft_server.go:98] Initializing new cluster
I0808 15:46:57 13248 master_server.go:95] [ localhost:9333 ] I am the leader!
</pre></div>
</div>
<p>STORAGE</p>
<div class="code powershell highlight-default"><div class="highlight"><pre><span></span><span class="c1"># in windows 10 x64</span>
<span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">aloor</span><span class="o">&gt;</span><span class="n">cd</span> <span class="n">Desktop</span>
<span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">aloor</span>\<span class="n">Desktop</span><span class="o">&gt;</span><span class="n">cd</span> <span class="n">temp</span>
<span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">aloor</span>\<span class="n">Desktop</span>\<span class="n">temp</span><span class="o">&gt;</span><span class="n">weed</span> <span class="n">volume</span> <span class="o">-</span><span class="nb">dir</span><span class="o">=</span><span class="s2">&quot;.\data1&quot;</span> <span class="o">-</span><span class="nb">max</span><span class="o">=</span><span class="mi">5</span>  <span class="o">-</span><span class="n">mserver</span><span class="o">=</span><span class="s2">&quot;localhost:9333&quot;</span> <span class="o">-</span><span class="n">port</span><span class="o">=</span><span class="mi">8080</span>
<span class="n">I0808</span> <span class="mi">15</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mi">27</span>  <span class="mi">5468</span> <span class="n">file_util</span><span class="o">.</span><span class="n">go</span><span class="p">:</span><span class="mi">20</span><span class="p">]</span> <span class="n">Folder</span> <span class="o">.</span>\<span class="n">data1</span> <span class="n">Permission</span><span class="p">:</span> <span class="o">-</span><span class="n">rwxrwxrwx</span>
<span class="n">I0808</span> <span class="mi">15</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mi">27</span>  <span class="mi">5468</span> <span class="n">disk_location</span><span class="o">.</span><span class="n">go</span><span class="p">:</span><span class="mi">106</span><span class="p">]</span> <span class="n">Store</span> <span class="n">started</span> <span class="n">on</span> <span class="nb">dir</span><span class="p">:</span> <span class="o">.</span>\<span class="n">data1</span> <span class="k">with</span> <span class="mi">0</span> <span class="n">volumes</span> <span class="nb">max</span> <span class="mi">5</span>
<span class="n">I0808</span> <span class="mi">15</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mi">27</span>  <span class="mi">5468</span> <span class="n">volume</span><span class="o">.</span><span class="n">go</span><span class="p">:</span><span class="mi">143</span><span class="p">]</span> <span class="n">Start</span> <span class="n">Seaweed</span> <span class="n">volume</span> <span class="n">server</span> <span class="mf">0.76</span> <span class="n">at</span> <span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span><span class="p">:</span><span class="mi">8080</span>
<span class="n">I0808</span> <span class="mi">15</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mi">27</span>  <span class="mi">5468</span> <span class="n">volume_grpc_client</span><span class="o">.</span><span class="n">go</span><span class="p">:</span><span class="mi">17</span><span class="p">]</span> <span class="n">Volume</span> <span class="n">server</span> <span class="n">bootstraps</span> <span class="k">with</span> <span class="n">master</span> <span class="n">localhost</span><span class="p">:</span><span class="mi">9333</span>
<span class="n">I0808</span> <span class="mi">15</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mi">27</span>  <span class="mi">5468</span> <span class="n">volume_grpc_client</span><span class="o">.</span><span class="n">go</span><span class="p">:</span><span class="mi">52</span><span class="p">]</span> <span class="n">Heartbeat</span> <span class="n">to</span> <span class="n">localhost</span><span class="p">:</span><span class="mi">9333</span>
</pre></div>
</div>
<div class="code powershell highlight-default"><div class="highlight"><pre><span></span><span class="c1"># in windows 10 x64</span>
<span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">aloor</span><span class="o">&gt;</span><span class="n">cd</span> <span class="n">Desktop</span>
<span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">aloor</span>\<span class="n">Desktop</span><span class="o">&gt;</span><span class="n">cd</span> <span class="n">temp</span>
<span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">aloor</span>\<span class="n">Desktop</span>\<span class="n">temp</span><span class="o">&gt;</span><span class="n">weed</span> <span class="n">volume</span> <span class="o">-</span><span class="nb">dir</span><span class="o">=</span><span class="s2">&quot;.\data2&quot;</span> <span class="o">-</span><span class="nb">max</span><span class="o">=</span><span class="mi">5</span>  <span class="o">-</span><span class="n">mserver</span><span class="o">=</span><span class="s2">&quot;localhost:9333&quot;</span> <span class="o">-</span><span class="n">port</span><span class="o">=</span><span class="mi">8081</span>
<span class="n">I0808</span> <span class="mi">15</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mi">58</span>  <span class="mi">9560</span> <span class="n">file_util</span><span class="o">.</span><span class="n">go</span><span class="p">:</span><span class="mi">20</span><span class="p">]</span> <span class="n">Folder</span> <span class="o">.</span>\<span class="n">data2</span> <span class="n">Permission</span><span class="p">:</span> <span class="o">-</span><span class="n">rwxrwxrwx</span>
<span class="n">I0808</span> <span class="mi">15</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mi">58</span>  <span class="mi">9560</span> <span class="n">disk_location</span><span class="o">.</span><span class="n">go</span><span class="p">:</span><span class="mi">106</span><span class="p">]</span> <span class="n">Store</span> <span class="n">started</span> <span class="n">on</span> <span class="nb">dir</span><span class="p">:</span> <span class="o">.</span>\<span class="n">data2</span> <span class="k">with</span> <span class="mi">0</span> <span class="n">volumes</span> <span class="nb">max</span> <span class="mi">5</span>
<span class="n">I0808</span> <span class="mi">15</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mi">58</span>  <span class="mi">9560</span> <span class="n">volume</span><span class="o">.</span><span class="n">go</span><span class="p">:</span><span class="mi">143</span><span class="p">]</span> <span class="n">Start</span> <span class="n">Seaweed</span> <span class="n">volume</span> <span class="n">server</span> <span class="mf">0.76</span> <span class="n">at</span> <span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span><span class="p">:</span><span class="mi">8081</span>
<span class="n">I0808</span> <span class="mi">15</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mi">58</span>  <span class="mi">9560</span> <span class="n">volume_grpc_client</span><span class="o">.</span><span class="n">go</span><span class="p">:</span><span class="mi">17</span><span class="p">]</span> <span class="n">Volume</span> <span class="n">server</span> <span class="n">bootstraps</span> <span class="k">with</span> <span class="n">master</span> <span class="n">localhost</span><span class="p">:</span><span class="mi">9333</span>
<span class="n">I0808</span> <span class="mi">15</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mi">58</span>  <span class="mi">9560</span> <span class="n">volume_grpc_client</span><span class="o">.</span><span class="n">go</span><span class="p">:</span><span class="mi">52</span><span class="p">]</span> <span class="n">Heartbeat</span> <span class="n">to</span> <span class="n">localhost</span><span class="p">:</span><span class="mi">9333</span>
</pre></div>
</div>
<p>上传文件</p>
<div class="code powershell highlight-default"><div class="highlight"><pre><span></span><span class="c1"># in windows 10 x64</span>
<span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">aloor</span><span class="o">&gt;</span><span class="n">cd</span> <span class="n">Desktop</span>
<span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">aloor</span>\<span class="n">Desktop</span><span class="o">&gt;</span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">9333</span><span class="o">/</span><span class="nb">dir</span><span class="o">/</span><span class="n">assign</span>
<span class="p">{</span><span class="s2">&quot;fid&quot;</span><span class="p">:</span><span class="s2">&quot;1,01de988801&quot;</span><span class="p">,</span><span class="s2">&quot;url&quot;</span><span class="p">:</span><span class="s2">&quot;127.0.0.1:8081&quot;</span><span class="p">,</span><span class="s2">&quot;publicUrl&quot;</span><span class="p">:</span><span class="s2">&quot;127.0.0.1:8081&quot;</span><span class="p">,</span><span class="s2">&quot;count&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span>
<span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">aloor</span>\<span class="n">Desktop</span><span class="o">&gt;</span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="n">PUT</span> <span class="o">-</span><span class="n">F</span> <span class="n">file</span><span class="o">=@.</span>\<span class="n">crystal</span><span class="o">.</span><span class="n">txt</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">8081</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="mi">01</span><span class="n">de988801</span>
<span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;crystal.txt&quot;</span><span class="p">,</span><span class="s2">&quot;size&quot;</span><span class="p">:</span><span class="mi">1147</span><span class="p">}</span>
</pre></div>
</div>
<p>接下来通过<code class="docutils literal"><span class="pre">http://127.0.0.1:8081/1,01de988801</span></code>就可以在浏览器上看到刚才上传的文件了。</p>
</div>
<div class="section" id="id3">
<h2>总结<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h2>
<p>seaweedfs虽然说是file system。但它其实是一个对象存储，这可以和openstack
swift类比。</p>
<ul class="simple">
<li>seaweedfs的master和datanode对应着swift的proxy server和storage node。</li>
<li>两者都支持http接口访问。</li>
<li>seaweedfs没有swift的middleware组件，因此目前无法编写插件。</li>
<li>seaweedfs的元数据是分层维护的。master维护的是各volume的信息。volume维护自己存储中的小文件的元数据。swift则是将元数据放到对象上。</li>
<li>seaweedfs的文件元数据是定制过的，有大小限制。每个文件的元数据大约8
bytes。作为对比，一个xfs_inode_t结构在Linux中需占用536 bytes。 &gt;
当前，Haystack平均为每个图片使用10byte的内存。每个上传的图片对应4张副本，它们共用同一个key（占64bits），alternate
keys不同（占32bits），size不同（占16bits），目前占用(64+(32+16)*4)/8=32个bytes。另外，对于每个副本，Haystack在用hash
table等结构时需要消耗额外的2个bytes，最终总量为一张图片的4份副本共占用40bytes。</li>
</ul>
<p>参考：</p>
<ol class="arabic simple">
<li><a class="reference external" href="http://luodw.cc/2017/01/05/weedfs/">SeaweedFS概述</a></li>
</ol>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">Starry</a></h1>








<h3>导航</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../days/index.html">日报</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">输出</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">输出</a><ul>
      <li>Previous: <a href="seaweedfs源码阅读(二).html" title="上一章">seaweedfs源码阅读(二)</a></li>
      <li>Next: <a href="swift_middleware.html" title="下一章">openstack swift middleware</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>快速搜索</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="转向" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, daqu.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.6.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
      |
      <a href="../_sources/outputs/seaweedfs简单介绍.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>