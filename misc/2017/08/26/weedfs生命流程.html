<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta http-equiv="Cache-Control" content="no-siteapp">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1, minimum-scale=1, maximum-scale=1">
<meta name="renderer" content="webkit">
<meta name="google" value="notranslate">
<meta name="robots" content="index,follow">


<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="钟俊的博客">
<meta name="twitter:description" content="记录">
<meta name="twitter:image:src" content="http://www.daqu.github.io/images/avatar.jpg">

<meta property="og:url" content="http://www.daqu.github.io">
<meta property="og:title" content="钟俊的博客">
<meta property="og:description" content="记录">
<meta property="og:site_name" content="钟俊的博客">
<meta property="og:image" content="http://www.daqu.github.io/images/avatar.jpg">
<meta property="og:type" content="website">
<meta name="robots" content="noodp">

<meta itemprop="name" content="钟俊的博客">
<meta itemprop="description" content="记录">
<meta itemprop="image" content="http://www.daqu.github.io/images/avatar.jpg">

<link rel="canonical" href="http://www.daqu.github.io">

<link rel="shortcut icon" href="/favicon.png">
<link rel="apple-itouch-icon" href="/favicon.png">
<link rel="stylesheet" href="/bundle/index.css">
<script type="text/javascript">
    var timeSinceLang = {
        year: '年前',
        month: '个月前',
        day: '天前',
        hour: '小时前',
        minute: '分钟前',
        second: '秒前'
    };
    var root = '';
</script>


        <meta name="keywords" content="输出,sds,seaweedfs,">
        <meta name="description" content="weedfs生命流程">
        <meta name="author" content="钟俊">
        <title>weedfs生命流程</title>
    </head>
    <body>
        <article class="container">
            <header class="header-wrap">
  <a class="index" href="/">
    <img class="logo" src="/images/avatar.jpg" />
    钟俊的博客
  </a>
  <ul class="menu">
      <li class="menu-item"><a href="/archive.html">归档</a></li>
      <li class="menu-item"><a href="/tag.html">标签</a></li>
      <li class="menu-item"><a href="/atom.xml">订阅</a></li>
  </ul>
</header>

            <article class="main article">
                <h1 class="title">weedfs生命流程</h1>
                <section class="info">
                    <span class="avatar" style="background-image: url(/images/avatar.jpg);"></span>
                    <a class="name" href="/about.me.html">钟俊</a>
                    
                    <span class="date" data-time="1503756000"><span class="from"></span></span>
                    
                    <span class="tags"><a class="tag" href="/tag/%e8%be%93%e5%87%ba/index.html">输出</a><a class="tag" href="/tag/sds/index.html">sds</a><a class="tag" href="/tag/seaweedfs/index.html">seaweedfs</a></span>
                </section>
                <article class="content"><h1>weedfs生命流程</h1>

<h2>(入口)./weed.go</h2>

<p>总入口，执行过程如下</p>

<pre><code class="language-go">func main() {
	glog.MaxSize = 1024 * 1024 * 32 
	rand.Seed(time.Now().UnixNano())
	flag.Usage = usage
	flag.Parse()	//设置一下背景

	args := flag.Args()
	if len(args) &lt; 1 {
		usage()
	}
//如果第一个参数是help，则跳转到help
	if args[0] == &quot;help&quot; {
		help(args[1:])
		for _, cmd := range commands {
			if len(args) &gt;= 2 &amp;&amp; cmd.Name() == args[1] &amp;&amp; cmd.Run != nil {
				fmt.Fprintf(os.Stderr, &quot;Default Parameters:\n&quot;)
				cmd.Flag.PrintDefaults()
			}
		}
		return
	}	
//主入口，根据commands构造参数，并执行run方法
	for _, cmd := range commands {
		if cmd.Name() == args[0] &amp;&amp; cmd.Run != nil {
			cmd.Flag.Usage = func() { cmd.Usage() }
			cmd.Flag.Parse(args[1:])
			args = cmd.Flag.Args()
			IsDebug = cmd.IsDebug
			if !cmd.Run(cmd, args) {
				fmt.Fprintf(os.Stderr, &quot;\n&quot;)
				cmd.Flag.Usage()
				fmt.Fprintf(os.Stderr, &quot;Default Parameters:\n&quot;)
				cmd.Flag.PrintDefaults()
			}
			exit()
			return
		}
	}
//有错误就输出
	fmt.Fprintf(os.Stderr, &quot;weed: unknown subcommand %q\nRun 'weed help' for usage.\n&quot;, args[0])
	setExitStatus(2)
	exit()
}
</code></pre>

<p>其中cmd.run函数的签名如下，接受一个命令和参数</p>

<pre><code class="language-go">Run func(cmd *Command, args []string) bool
</code></pre>

<p>Command的结构如下</p>

<pre><code class="language-go">var Commands = []*Command{
	cmdBenchmark,	//测试
	cmdBackup,		//备份
	cmdCompact,		//合并？备份
	cmdCopy,		//文件复制
	cmdFix,			//重建索引
	cmdServer,		//同时启动Master服务和Volume服务
	cmdMaster,		//Master服务
	cmdFiler,		//启动文件服务器，处理rest请求
	cmdUpload,		//上传文件
	cmdDownload,	//下载文件
	cmdShell,		//开启交互命令行
	cmdVersion,		//打印weedfs版本
	cmdVolume,		//Volume服务
	cmdExport,		//列出所有文件或者将数据导出
	cmdMount,		//挂载filer到usespace，FUSE
}
</code></pre>

<p>入口函数会使用range语法遍历Command里面的成员，不空则执行对应的命令</p>

<h2>(请求)./weed/command/master.go</h2>

<p>如果执行的是master命令，那么这次命令将启动master服务。当执行master命令时，程序将从入口函数切换到master模块，执行该模块下的runMaster函数。这个函数最主要的功能是新建了一个mux实例。</p>

<pre><code class="language-go">// 节选func run	r := mux.NewRouter()
	ms := weed_server.NewMasterServer(r,
                                      *mport,
                                      *metaFolder,
                                      *volumeSizeLimitMB, 
                                      *volumePreallocate,
                                      *mpulse,               
                                   *defaultReplicaPlacement, 
                                      *garbageThreshold,
                                      masterWhiteList, 
                                      *masterSecureKey,
	)Master(cmd *Command, args []string) bool
	r := mux.NewRouter()
	ms := weed_server.NewMasterServer(r, *mport, 
                                      *metaFolder,
                                      *volumeSizeLimitMB, 
                                      *volumePreallocate,
                                      *mpulse, 
                                   *defaultReplicaPlacement, 
                                      *garbageThreshold,
                                      masterWhiteList, 
                                      *masterSecureKey,
	)
</code></pre>

<blockquote>
<p>golang自带的<a href="http://studygolang.com/articles/4890">http.SeverMux路由实现</a>简单,本质是一个map[string]Handler,是请求路径与该路径对应的处理函数的映射关系。实现简单功能也比较单一
1. 不支持正则路由， 这个是比较致命的
2. 只支持路径匹配，不支持按照Method，header，host等信息匹配，所以也就没法实现RESTful架构</p>

<p>而gorilla/mux是一个强大的路由，小巧但是稳定高效，不仅可以支持正则路由还可以按照Method，header，host等信息匹配，可以从我们设定的路由表达式中提取出参数方便上层应用，而且完全兼容http.ServerMux</p>
</blockquote>

<p>具体的路由处理函数被放到了weed/server/master_server.go里面</p>

<pre><code class="language-go">	r.HandleFunc(&quot;/&quot;, ms.uiStatusHandler)
	r.HandleFunc(&quot;/ui/index.html&quot;, ms.uiStatusHandler)
	r.HandleFunc(&quot;/dir/assign&quot;, ms.proxyToLeader(ms.guard.WhiteList(ms.dirAssignHandler)))
	r.HandleFunc(&quot;/dir/lookup&quot;, ms.proxyToLeader(ms.guard.WhiteList(ms.dirLookupHandler)))
	r.HandleFunc(&quot;/dir/status&quot;, ms.proxyToLeader(ms.guard.WhiteList(ms.dirStatusHandler)))
	r.HandleFunc(&quot;/col/delete&quot;, ms.proxyToLeader(ms.guard.WhiteList(ms.collectionDeleteHandler)))
	r.HandleFunc(&quot;/vol/lookup&quot;, ms.proxyToLeader(ms.guard.WhiteList(ms.volumeLookupHandler)))
	r.HandleFunc(&quot;/vol/grow&quot;, ms.proxyToLeader(ms.guard.WhiteList(ms.volumeGrowHandler)))
	r.HandleFunc(&quot;/vol/status&quot;, ms.proxyToLeader(ms.guard.WhiteList(ms.volumeStatusHandler)))
	r.HandleFunc(&quot;/vol/vacuum&quot;, ms.proxyToLeader(ms.guard.WhiteList(ms.volumeVacuumHandler)))
	r.HandleFunc(&quot;/submit&quot;, ms.guard.WhiteList(ms.submitFromMasterServerHandler))
	r.HandleFunc(&quot;/delete&quot;, ms.guard.WhiteList(ms.deleteFromMasterServerHandler))
	r.HandleFunc(&quot;/{fileId}&quot;, ms.proxyToLeader(ms.redirectHandler))
	r.HandleFunc(&quot;/stats/counter&quot;, ms.guard.WhiteList(statsCounterHandler))
	r.HandleFunc(&quot;/stats/memory&quot;, ms.guard.WhiteList(statsMemoryHandler))
</code></pre>

<p>可以看到master部分负责的路由，对应的方法也是被二次封装了。被封装成</p>

<pre><code class="language-go">func (ms *MasterServer) proxyToLeader(f func(w http.ResponseWriter, r *http.Request)) func(w http.ResponseWriter, r *http.Request)
</code></pre>

<p>不但如此，请求和响应也被封装到了一个函数里面。它的签名是</p>

<pre><code class="language-go">func (g *Guard) WhiteList(f func(w http.ResponseWriter, r *http.Request)) func(w http.ResponseWriter, r *http.Request)
</code></pre>

<p>在这里weeedfs通过封装的方式将请求交给了安全模块/weed/guard。但目前这里似乎是一片空白。。。因为guard也是继续转发请求，但是这次是直接交到后台程序。</p>

<p>至此，整个请求部分就完成了。</p>

<p>(响应)</p>
</article>
                <section class="author">
                    <div class="avatar" style="background-image: url(/images/avatar.jpg);"></div>
                    <a class="name" href="/about.me.html">钟俊</a>
                    <div class="intro">没有介绍</div>
                </section>
                <section class="recommend">
                    
                    <section class="nav prev more">
                        <div class="head">上篇文章</div>
                        <a class="link" href="/misc/2017/08/26/openstack%20storlet%e7%ae%80%e5%8d%95%e4%bb%8b%e7%bb%8d.html">openstack storlet简单介绍</a>
                    </section>
                    
                    
                    <section class="nav next more">
                        <div class="head">下篇文章</div>
                        <a class="link" href="/misc/2017/08/26/seaweedfs%e7%ae%80%e5%8d%95%e4%bb%8b%e7%bb%8d.html">seaweedfs简单介绍</a>
                    </section>
                    
                </section>
                
    <section id="disqus_thread"></section>
    <script type="text/javascript">
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//username.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>


            </article>
        </article>
        <footer class="footer">
    <span class="copyright">
        钟俊的博客 ©
        <script type="text/javascript">
            document.write(new Date().getFullYear());
        </script>
    </span>
    <span class="publish">Powered by <a href="http://www.chole.io/" target="_blank">Ink</a></span>
</footer>

        <script src="/bundle/index.js"></script>
    </body>
</html>
